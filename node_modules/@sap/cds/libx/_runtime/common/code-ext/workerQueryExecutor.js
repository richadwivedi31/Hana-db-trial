const cds = require('../../cds')
const { parentPort } = require('worker_threads')
const executorCallbackMap = new Map()

parentPort.on('message', function onMessageReceived({ id, kind, result }) {
  if (!executorCallbackMap.has(id)) return

  switch (kind) {
    case 'responseData':
      executorCallbackMap.get(id)(result)
      executorCallbackMap.delete(id)
      return

    case 'cleanup':
      executorCallbackMap.delete(id)
      return
  }
})

function queryExecutor(resolve, reject) {
  const id = cds.utils.uuid()
  executorCallbackMap.set(id, result => resolve(result))
  parentPort.postMessage({
    id,
    kind: 'run',
    target: 'srv',
    prop: 'run',
    responseData: true,
    args: [this]
  })
}

module.exports = queryExecutor
