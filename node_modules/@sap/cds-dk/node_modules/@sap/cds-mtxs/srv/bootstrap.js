const cds = require ('@sap/cds/lib')
const DEBUG = cds.debug('mtx')

class MTXServices extends cds.Service { async init(){
  if (cds.mtx) {
    DEBUG && DEBUG ('bootstrapping old MTX...')
    await cds.mtx.in (cds.app) // old mtxExtension
    if (!process.env.MTX_MIGRATION) return
  }
  // else...
  DEBUG && DEBUG ('bootstrapping MTX services...')
  let { $sources, definitions } = cds.model
  let models = []

  if (cds.requires.multitenancy) {
    _serve ('cds.xt.SaasProvisioningService')
    _serve ('cds.xt.DeploymentService')
    _serve ('cds.xt.ModelProviderService')
  }

  if (cds.requires.extensibility) {
    _serve ('cds.xt.ExtensibilityService')
    _serve ('cds.xt.ModelProviderService')
  }

  if (cds.requires.toggles) {
    _serve ('cds.xt.ModelProviderService')
  }

  function _serve (service) {
    if (service in definitions) return
    else models.push(cds.requires.kinds[service].model)
  }

  if (models?.length) return cds.serve(models).in(cds.app)
}}

module.exports = MTXServices
