const { yaml: YAML } = require('@sap/cds-foss')
const JSONC = require('../../util/jsonc');
const { read, write } = require('../../cds').utils;

module.exports = new class FsUtil {

    async readYAML(src, projectDescriptor) {
        let file
        try {
            file = await read(src, 'utf8')
        } catch (e) {
            if (e.code === 'ENOENT') return undefined
            throw e
        }
        if (projectDescriptor) {
            const Mustache = require('mustache')
            const renderedFile = Mustache.render(file, projectDescriptor)
            return YAML.parseDocument(renderedFile)
        }
        return YAML.parseDocument(file)
    }

    async writeYAML(filepath, yaml) {
        const content = YAML.stringify(yaml, { collectionStyle: 'block' })
        await write(filepath, content)
    }

    async readJSON(src, projectDescriptor) {
        const file = await read(src, 'utf8')
        if (projectDescriptor) {
            const Mustache = require('mustache')
            const renderedFile = Mustache.render(file, projectDescriptor)
            return JSON.parse(renderedFile)
        }
        return JSON.parse(file)
    }

    async readJSONC(src) {
        return JSONC.parse(await read(src, 'utf8'))
    }
}
