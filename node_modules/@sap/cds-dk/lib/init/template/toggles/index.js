const { join } = require('path')
const ProjectReader = require('../../util/projectReader')
const { mergeJSON, sortDependencies } = require('../../util/merge')

module.exports = class TogglesTemplate extends require('../templateBase') {
  constructor(projectPath, generator) {
    super(projectPath, generator, __dirname)
    this.projectReader = new ProjectReader(projectPath)
  }

  static hasFacet(env) {
    return !!env.requires?.toggles
  }

  async run() {
    const projectDescriptor = await this.projectReader.read(this.options)
    const { for: forProfile, isNodejs, isJava } = projectDescriptor.cap
    if (isNodejs) {
      const packageJSONPath = join(this.projectPath, 'package.json')
      const cdsTemplateFile = forProfile ? 'cds.package.json.hbs' : 'cds.package.json'
      await mergeJSON(packageJSONPath, join(__dirname, 'files', cdsTemplateFile), projectDescriptor)
      await sortDependencies(packageJSONPath)
    } else if (isJava) {
      const cdsrcPath = join(this.projectPath, '.cdsrc.json')
      const cdsTemplateFile = join(__dirname, 'files', forProfile ? 'cdsrc.json.hbs' : 'cdsrc.json')
      await mergeJSON(cdsrcPath, cdsTemplateFile, projectDescriptor)
    }
    await this.runDependentMerging()
  }
}
